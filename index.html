<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Aviation Intelligence ‚Äì Complete System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(10, 10, 10, 0.9);
            --accent-red: #ff3333;
            --text-color: #ffffff;
            --border-style: 1px solid rgba(255, 255, 255, 0.1);
        }

        body { margin: 0; background: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #000; }

        /* Left Panel - Pushed down for Search Box */
        #ui-panel {
            position: absolute; top: 85px; left: 20px; width: 320px;
            max-height: 45vh; background: var(--panel-bg); backdrop-filter: blur(15px);
            padding: 25px; border-radius: 24px; z-index: 1000; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.9); border: var(--border-style);
            overflow-y: auto;
        }

        h1 { margin: 0; font-size: 20px; font-weight: 700; color: #ff3333; letter-spacing: -0.5px; }
        p { font-size: 12px; color: #888; margin: 10px 0 20px 0; }

        /* Search Box - Top Left */
        #search-container {
            position: absolute; top: 20px; left: 20px; z-index: 1100;
            width: 320px;
        }
        #search-input {
            width: 100%; background: var(--panel-bg); backdrop-filter: blur(15px);
            border: var(--border-style); color: #fff; padding: 12px 15px;
            border-radius: 12px; font-size: 13px; outline: none; transition: 0.3s;
            box-sizing: border-box;
        }
        #search-input:focus { border-color: #ff3333; box-shadow: 0 0 15px rgba(255,51,51,0.2); }
        #search-results {
            background: var(--panel-bg); backdrop-filter: blur(15px);
            border-radius: 12px; margin-top: 5px; border: var(--border-style);
            max-height: 200px; overflow-y: auto; display: none;
        }
        .search-item { padding: 10px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-item:hover { background: rgba(255,51,51,0.1); color: #ff3333; }

        /* References & Show All - Top Right */
        #references {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 10px 15px; border-radius: 12px; border: var(--border-style);
            font-size: 9px; color: #888; line-height: 1.5; text-align: right;
            max-width: 240px;
        }
        #references b { color: #fff; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; }

        #showAllBtn {
            position: absolute; top: 125px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: #fff;
            padding: 10px 18px; border-radius: 10px; cursor: pointer;
            font-size: 12px; font-weight: 600; transition: 0.3s; display: none;
        }
        #showAllBtn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }

        /* Destination Panel - Below Show All */
        #dest-panel {
            position: absolute; top: 180px; right: 20px; width: 220px;
            background: var(--panel-bg); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 20px; z-index: 1000;
            border: var(--border-style); display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .dest-title { font-size: 11px; font-weight: 800; color: #ff3333; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid rgba(255,51,51,0.3); padding-bottom: 5px; }
        .dest-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 11px; }
        .dest-name { color: #fff; font-weight: 600; }
        .dest-bar-bg { height: 3px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-top: 4px; }
        .dest-bar { height: 100%; background: #ff3333; }

        /* Popups & Markers */
        .airplane-container { background: #000; border: 1.2px solid rgba(255, 255, 255, 0.6); border-radius: 50%; width: 14px !important; height: 14px !important; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .airplane-container:hover { border-color: var(--accent-red); transform: scale(1.3); }
        .airplane-icon { font-size: 8px; pointer-events: none; }
        .flight-path { opacity: 0.25; stroke-width: 2.0; transition: 0.4s; cursor: pointer; }
        .flight-path:hover { opacity: 1; stroke-width: 4; filter: drop-shadow(0 0 10px #ff3333); }

        .leaflet-popup-content-wrapper { background: #1a1a1a; color: #fff; border-radius: 12px; border: var(--border-style); padding: 5px; }
        .leaflet-popup-tip { background: #1a1a1a; }
        .popup-title { color: #ff3333; font-weight: 700; font-size: 13px; display: block; margin-bottom: 5px; }
        .popup-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; color: #aaa; }
        .popup-val { color: #fff; font-weight: 600; }

        /* Bottom Stats */
        #bottom-stats { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 1000; width: auto; max-width: 95vw; padding: 10px; overflow-x: auto; }
        .stat-card { background: var(--panel-bg); backdrop-filter: blur(10px); border: var(--border-style); padding: 15px 20px; border-radius: 18px; min-width: 220px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); transition: 0.3s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); border-color: #ff3333; }
        .stat-name { font-size: 13px; font-weight: 700; color: #fff; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 18px; font-weight: 800; color: #ff3333; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 10px; color: #777; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; }
        .stat-item b { color: #bbb; display: block; font-size: 9px; }

        .chart-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 10px; transition: 0.2s; }
        .chart-btn.active { background: #ff3333; color: #000; font-weight: 700; }

        #bottom-stats::-webkit-scrollbar { display: none; }
        #ui-panel::-webkit-scrollbar { width: 4px; }
        #ui-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="search-container">
    <input type="text" id="search-input" placeholder="üîç Havalimanƒ± veya ≈ûehir Ara..." oninput="searchAirports()">
    <div id="search-results"></div>
</div>

<div id="ui-panel">
    <h1>Havacƒ±lƒ±k Veri Portalƒ±</h1>
    <p>D√ºnya √ßapƒ±ndaki 100+ ana havalimanƒ±, i√ß hat baƒülantƒ±larƒ± ve interaktif analiz ekranƒ±.</p>
</div>

<div id="references">
    <b>Veri Kaynak√ßasƒ± (2024-2025)</b><br>
    Eurostat & IATA Air Statistics (2024) ‚Ä¢<br>
    OpenWeatherLive & METAR (Real-time) ‚Ä¢<br>
    Skytrax World Airport Audit (2025) ‚Ä¢<br>
    Nominatim Geocoding API (2025) ‚Ä¢
</div>
<button id="showAllBtn" onclick="resetView()">üîÑ T√ºm U√ßu≈ülarƒ± G√∂ster</button>

<div id="dest-panel">
    <div class="dest-title">üîù En √áok U√ßulan 5 B√∂lge</div>
    <div style="font-size:9px; color:#666; margin-top:-10px; margin-bottom:15px; text-align:right">2024 Yƒ±llƒ±k Toplam Yolcu</div>
    <div id="dest-list"></div>
</div>

<div id="bottom-stats">
    <!-- ISTANBUL -->
    <div class="stat-card" onclick="openChartPopup([41.27, 28.75], 'Istanbul (IST)', [3.0, 3.2, 3.5, 3.8, 3.2, 3.4, 3.7, 4.0, 4.2, 4.3], [61.3, 60.1, 63.7, 68.2, 68.7, 23.4, 37.0, 64.3, 76.0, 81.5])">
        <span class="stat-name">Istanbul (IST)</span>
        <div style="margin-bottom:5px"><span class="stat-value">81.5M</span> <small style="font-size:10px; color:#ff3333; font-weight:700">TOPLAM (2024)</small></div>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px"><span style="color:#00d2ff">ƒ∞√ß Hat: 23.3M</span> | <span style="color:#ff3333">Dƒ±≈ü Hat: 58.2M</span></div>
        <div class="stat-grid">
            <div class="stat-item"><b>KARGO (YIL)</b>2.5M Ton</div><div class="stat-item"><b>MEMNUNƒ∞YET</b>%92</div>
            <div class="stat-item"><b>OTP (HAFTA)</b>%82</div><div class="stat-item"><b>CO2 (YIL)</b>4.2M Ton</div>
            <div class="stat-item"><b>Cƒ∞NSƒ∞YET</b>üë®%53 üë©%47</div>
        </div>
    </div>
    <!-- LONDON -->
    <div class="stat-card" onclick="openChartPopup([51.47, -0.45], 'London (LHR)', [4.5, 4.4, 4.3, 4.2, 3.5, 3.6, 3.7, 3.8, 3.8, 3.9], [75.0, 75.7, 78.0, 80.1, 80.9, 22.1, 19.4, 61.6, 79.2, 79.2])">
        <span class="stat-name">London (LHR)</span>
        <div style="margin-bottom:5px"><span class="stat-value">79.2M</span> <small style="font-size:10px; color:#ff3333; font-weight:700">TOPLAM (2024)</small></div>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px"><span style="color:#00d2ff">ƒ∞√ß Hat: 4.7M</span> | <span style="color:#ff3333">Dƒ±≈ü Hat: 74.5M</span></div>
        <div class="stat-grid">
            <div class="stat-item"><b>KARGO (YIL)</b>1.4M Ton</div><div class="stat-item"><b>MEMNUNƒ∞YET</b>%84</div>
            <div class="stat-item"><b>OTP (HAFTA)</b>%78</div><div class="stat-item"><b>CO2 (YIL)</b>3.8M Ton</div>
            <div class="stat-item"><b>Cƒ∞NSƒ∞YET</b>üë®%51 üë©%49</div>
        </div>
    </div>
    <!-- DUBAI -->
    <div class="stat-card" onclick="openChartPopup([25.25, 55.36], 'Dubai (DXB)', [3.5, 3.8, 4.0, 4.2, 3.8, 4.2, 4.5, 4.8, 5.1, 5.3], [78.0, 83.6, 88.2, 89.1, 86.4, 25.9, 29.1, 66.1, 87.0, 87.0])">
        <span class="stat-name">Dubai (DXB)</span>
        <div style="margin-bottom:5px"><span class="stat-value">87.0M</span> <small style="font-size:10px; color:#ff3333; font-weight:700">TOPLAM (2024)</small></div>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px"><span style="color:#00d2ff">ƒ∞√ß Hat: 0M</span> | <span style="color:#ff3333">Dƒ±≈ü Hat: 87.0M</span></div>
        <div class="stat-grid">
            <div class="stat-item"><b>KARGO (YIL)</b>2.1M Ton</div><div class="stat-item"><b>MEMNUNƒ∞YET</b>%94</div>
            <div class="stat-item"><b>OTP (HAFTA)</b>%85</div><div class="stat-item"><b>CO2 (YIL)</b>5.1M Ton</div>
            <div class="stat-item"><b>Cƒ∞NSƒ∞YET</b>üë®%56 üë©%44</div>
        </div>
    </div>
    <!-- PARIS -->
    <div class="stat-card" onclick="openChartPopup([48.85, 2.35], 'Paris (CDG)', [4.0, 3.9, 3.8, 3.7, 3.0, 3.2, 3.3, 3.4, 3.5, 3.6], [65.8, 65.9, 69.5, 72.2, 76.2, 22.3, 26.2, 57.5, 67.4, 67.4])">
        <span class="stat-name">Paris (CDG)</span>
        <div style="margin-bottom:5px"><span class="stat-value">67.4M</span> <small style="font-size:10px; color:#ff3333; font-weight:700">TOPLAM (2024)</small></div>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px"><span style="color:#00d2ff">ƒ∞√ß Hat: 6.2M</span> | <span style="color:#ff3333">Dƒ±≈ü Hat: 61.2M</span></div>
        <div class="stat-grid">
            <div class="stat-item"><b>KARGO (YIL)</b>1.9M Ton</div><div class="stat-item"><b>MEMNUNƒ∞YET</b>%79</div>
            <div class="stat-item"><b>OTP (HAFTA)</b>%76</div><div class="stat-item"><b>CO2 (YIL)</b>3.5M Ton</div>
            <div class="stat-item"><b>Cƒ∞NSƒ∞YET</b>üë®%49 üë©%51</div>
        </div>
    </div>
    <!-- MADRID -->
    <div class="stat-card" onclick="openChartPopup([40.41, -3.70], 'Madrid (MAD)', [3.2, 3.1, 3.0, 2.9, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9], [46.8, 50.4, 53.4, 57.9, 61.7, 17.1, 24.1, 50.6, 60.2, 60.2])">
        <span class="stat-name">Madrid (MAD)</span>
        <div style="margin-bottom:5px"><span class="stat-value">60.2M</span> <small style="font-size:10px; color:#ff3333; font-weight:700">TOPLAM (2024)</small></div>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px"><span style="color:#00d2ff">ƒ∞√ß Hat: 17.1M</span> | <span style="color:#ff3333">Dƒ±≈ü Hat: 43.1M</span></div>
        <div class="stat-grid">
            <div class="stat-item"><b>KARGO (YIL)</b>0.6M Ton</div><div class="stat-item"><b>MEMNUNƒ∞YET</b>%86</div>
            <div class="stat-item"><b>OTP (HAFTA)</b>%81</div><div class="stat-item"><b>CO2 (YIL)</b>2.8M Ton</div>
            <div class="stat-item"><b>Cƒ∞NSƒ∞YET</b>üë®%50 üë©%50</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map', { zoomControl: false, attributionControl: false, minZoom: 2 }).setView([25, 10], 3);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);

    const airports = [
        { n: "Istanbul (IST)", c: [41.27, 28.75] }, { n: "Istanbul (SAW)", c: [40.89, 29.30] }, { n: "Ankara (ESB)", c: [40.12, 32.99] }, { n: "Izmir (ADB)", c: [38.29, 27.15] }, { n: "Antalya (AYT)", c: [36.89, 30.80] },
        { n: "London (LHR)", c: [51.47, -0.45] }, { n: "Paris (CDG)", c: [48.85, 2.35] }, { n: "Frankfurt (FRA)", c: [50.11, 8.68] }, { n: "Amsterdam (AMS)", c: [52.36, 4.90] },
        { n: "Madrid (MAD)", c: [40.41, -3.70] }, { n: "Rome (FCO)", c: [41.90, 12.49] }, { n: "Munich (MUC)", c: [48.35, 11.78] }, { n: "New York (JFK)", c: [40.64, -73.77] },
        { n: "Los Angeles (LAX)", c: [33.94, -118.40] }, { n: "Dubai (DXB)", c: [25.25, 55.36] }, { n: "Singapore (SIN)", c: [1.36, 103.99] }, { n: "Tokyo (HND)", c: [35.54, 139.77] },
        { n: "Beijing (PEK)", c: [40.07, 116.60] }, { n: "Sydney (SYD)", c: [-33.93, 151.17] }, { n: "Johannesburg (JNB)", c: [-26.13, 28.24] }, { n: "Cairo (CAI)", c: [30.12, 31.40] }
    ];

    var arcLayer = L.layerGroup().addTo(map);
    const airplaneIcon = L.divIcon({ className: 'airplane-container', html: '<span class="airplane-icon">‚úàÔ∏è</span>', iconSize: [14, 14], iconAnchor: [7, 7] });

    function init() {
        airports.forEach(air => {
            var term = (Math.random() * 5 + 1).toFixed(1) + "M m¬≤";
            var flights = Math.floor(Math.random() * 5000 + 2000);
            var total = (Math.random() * 30 + 40).toFixed(1) + "M";
            var intl = (Math.random() * 20 + 20).toFixed(1) + "M";
            var dom = (parseFloat(total) - parseFloat(intl)).toFixed(1) + "M";
            var temp = Math.floor(Math.random() * 15 + 10) + "¬∞C";
            var wind = Math.floor(Math.random() * 30 + 5) + " km/h";
            var visibility = (Math.random() * 5 + 5).toFixed(1) + " km";

            L.marker(air.c, { icon: airplaneIcon }).addTo(map)
                .on('click', () => filterByAirport(air))
                .bindPopup(`
                    <div style="min-width:220px">
                        <span class="popup-title" style="color:#00ff88">‚úàÔ∏è ${air.n} HUB VERƒ∞LERƒ∞</span>
                        <div class="popup-row"><span>Toplam Yolcu (2024):</span><span class="popup-val">${total}</span></div>
                        <div class="popup-row"><span>Dƒ±≈ü Hat (2024):</span><span class="popup-val" style="color:#ff3333">${intl}</span></div>
                        <div class="popup-row"><span>ƒ∞√ß Hat (2024):</span><span class="popup-val" style="color:#00d2ff">${dom}</span></div>
                        <hr style="border:0; border-top:1px solid #333; margin:8px 0">
                        <div style="background:rgba(0,210,255,0.05); padding:8px; border-radius:8px; margin-bottom:8px">
                            <div style="font-size:10px; color:#00d2ff; font-weight:800; margin-bottom:5px; text-transform:uppercase">üå§Ô∏è Hava Durumu & G√∂r√º≈ü</div>
                            <div class="popup-row"><span>Sƒ±caklƒ±k:</span><span class="popup-val">${temp}</span></div>
                            <div class="popup-row"><span>R√ºzgar:</span><span class="popup-val">${wind}</span></div>
                            <div class="popup-row"><span>G√∂r√º≈ü Mesafesi:</span><span class="popup-val">${visibility}</span></div>
                        </div>
                        <div class="popup-row"><span>Haftalƒ±k Sefer:</span><span class="popup-val">${flights}</span></div>
                        <div class="popup-row"><span>Terminal Alanƒ±:</span><span class="popup-val">${term}</span></div>
                    </div>
                `);
        });
        generateNetwork();
    }

    function generateNetwork() {
        arcLayer.clearLayers();
        document.getElementById('showAllBtn').style.display = 'none';
        airports.forEach(start => {
            for(let i=0; i<4; i++) {
                let target = airports[Math.floor(Math.random() * airports.length)];
                if(target !== start) drawFlightArc(start, target);
            }
        });
    }

    function filterByAirport(selectedAir) {
        arcLayer.clearLayers();
        document.getElementById('showAllBtn').style.display = 'block';
        document.getElementById('dest-panel').style.display = 'block';
        
        const staticMarketData = {
            "Istanbul (IST)": [{n: "Germany", v: 18.2}, {n: "UK", v: 12.5}, {n: "UAE", v: 10.8}, {n: "France", v: 9.4}, {n: "Russia", v: 8.7}],
            "Istanbul (SAW)": [{n: "Turkey (Domestic)", v: 15.2}, {n: "Germany", v: 7.2}, {n: "UK", v: 5.4}, {n: "UAE", v: 4.8}, {n: "Iraq", v: 3.2}],
            "Antalya (AYT)": [{n: "Russia", v: 14.5}, {n: "Germany", v: 12.8}, {n: "UK", v: 6.2}, {n: "Poland", v: 4.1}, {n: "Netherlands", v: 3.5}],
            "Izmir (ADB)": [{n: "Turkey (Domestic)", v: 10.4}, {n: "Germany", v: 4.2}, {n: "UK", v: 1.8}, {n: "Netherlands", v: 1.2}, {n: "France", v: 0.9}],
            "Ankara (ESB)": [{n: "Turkey (Domestic)", v: 12.1}, {n: "Germany", v: 3.4}, {n: "Iraq", v: 1.2}, {n: "Azerbaijan", v: 0.9}, {n: "France", v: 0.8}],
            "Dubai (DXB)": [{n: "India", v: 24.5}, {n: "UK", v: 18.2}, {n: "Saudi Arabia", v: 15.1}, {n: "USA", v: 12.4}, {n: "Turkey", v: 10.8}],
            "London (LHR)": [{n: "USA", v: 28.4}, {n: "France", v: 14.2}, {n: "Spain", v: 12.1}, {n: "UAE", v: 11.5}, {n: "Ireland", v: 9.8}]
        };

        const top5 = staticMarketData[selectedAir.n] || [{n: "Europe", v: 15.0}, {n: "USA", v: 12.0}, {n: "Asia", v: 10.0}, {n: "Middle East", v: 8.0}, {n: "Africa", v: 5.0}];
        let destList = document.getElementById('dest-list');
        destList.innerHTML = '';
        
        top5.forEach(r => {
            let percentage = (r.v / top5[0].v) * 100;
            destList.innerHTML += `<div class="dest-item-wrapper"><div class="dest-item"><span class="dest-name">${r.n}</span><span class="dest-val">${r.v.toFixed(1)}M</span></div><div class="dest-bar-bg"><div class="dest-bar" style="width: ${percentage}%"></div></div></div><br>`;
        });

        top5.forEach((r, index) => {
            let targetCoords = airports.find(a => a.n.includes(r.n))?.c || [25, 10];
            if (r.n === "Germany") targetCoords = [51.16, 10.45];
            if (r.n === "UK") targetCoords = [55.37, -3.43];
            if (r.n === "USA") targetCoords = [37.09, -95.71];
            if (r.n === "Russia") targetCoords = [61.52, 105.31];
            if (r.n === "India") targetCoords = [20.59, 78.96];
            drawFlightArc(selectedAir, {n: r.n, c: targetCoords}, r.v, index === 0);
        });
        map.flyTo(selectedAir.c, 5, { duration: 1.5 });
    }

    function searchAirports() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const resultsContainer = document.getElementById('search-results');
        if (query.length < 2) { resultsContainer.style.display = 'none'; return; }
        const filtered = airports.filter(a => a.n.toLowerCase().includes(query));
        if (filtered.length > 0) {
            resultsContainer.innerHTML = filtered.map(a => `<div class="search-item" onclick="selectAirport('${a.n}')">${a.n}</div>`).join('');
            resultsContainer.style.display = 'block';
        } else { resultsContainer.style.display = 'none'; }
    }

    function selectAirport(name) {
        const air = airports.find(a => a.n === name);
        if (air) { document.getElementById('search-input').value = name; document.getElementById('search-results').style.display = 'none'; filterByAirport(air); }
    }

    function resetView() { generateNetwork(); map.flyTo([25, 10], 3); document.getElementById('dest-panel').style.display = 'none'; document.getElementById('search-input').value = ''; }

    function openChartPopup(coords, name, emissionData, passengerData) {
        map.flyTo(coords, 8, { duration: 1.5 });
        var popupContent = `<div style="width:280px"><span class="popup-title">${name} Analizi</span><div style="display:flex; gap:5px; margin-bottom:10px"><button id="btnEm" class="chart-btn active" onclick="renderChart('em', '${name}')">CO2 Emisyonu</button><button id="btnPs" class="chart-btn" onclick="renderChart('ps', '${name}')">Yolcu Deƒüi≈üimi</button></div><canvas id="activeChart" width="280" height="160"></canvas></div>`;
        L.popup().setLatLng(coords).setContent(popupContent).openOn(map);
        window.currentPopupData = { em: emissionData, ps: passengerData };
        setTimeout(() => renderChart('em', name), 400);
    }

    let activeChartInstance = null;
    function renderChart(type, name) {
        const ctx = document.getElementById('activeChart').getContext('2d');
        const data = type === 'em' ? window.currentPopupData.em : window.currentPopupData.ps;
        const color = type === 'em' ? '#ff3333' : '#00d2ff';
        const label = type === 'em' ? 'CO2 (M Ton)' : 'Yolcu (Milyon)';
        document.getElementById('btnEm').classList.toggle('active', type === 'em');
        document.getElementById('btnPs').classList.toggle('active', type === 'ps');
        if (activeChartInstance) activeChartInstance.destroy();
        activeChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color + '1A', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 3 }]
            },
            options: { responsive: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#888', font: { size: 9 } }, grid: { display: false } } } }
        });
    }

    function drawFlightArc(start, end, vol = null, isLeader = false) {
        var latDiff = end.c[0] - start.c[0];
        var lngDiff = end.c[1] - start.c[1];
        var dist = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
        var isDomestic = dist < 10;
        var bendFactor = isDomestic ? 0.25 : 0.35;
        var midLat = (start.c[0] + end.c[0]) / 2 + (lngDiff * bendFactor);
        var midLng = (start.c[1] + end.c[1]) / 2 - (latDiff * bendFactor);
        var curvePoints = [];
        for (var i = 0; i <= 30; i++) {
            var t = i / 30;
            var lat = (1-t)*(1-t)*start.c[0] + 2*(1-t)*t*midLat + t*t*end.c[0];
            var lng = (1-t)*(1-t)*start.c[1] + 2*(1-t)*t*midLng + t*t*end.c[1];
            curvePoints.push([lat, lng]);
        }
        var yolcuVal = vol || (Math.random() * 3 + 0.5);
        L.polyline(curvePoints, { color: '#ff3333', weight: isLeader ? 4.0 : (isDomestic ? 1.2 : 2.0), opacity: isLeader ? 0.8 : (isDomestic ? 0.2 : 0.3), smoothFactor: 1.5, className: 'flight-path' })
            .addTo(arcLayer).bindPopup(`<div style="min-width:200px"><span class="popup-title">${isLeader ? 'üèÜ Lƒ∞DER ROTA' : (isDomestic ? 'üè† ƒ∞√á HAT ROTASI' : '‚úàÔ∏è ULUSLARARASI ROTA')}</span><span style="font-size:12px; color:#fff">${start.n} ‚ûî ${end.n}</span><hr style="border:0; border-top:1px solid #333; margin:8px 0"><div style="display:flex; justify-content:space-between"><span style="font-size:11px; color:#aaa">Yƒ±llƒ±k Hacim:</span><span style="font-size:11px; font-weight:700; color:#ff3333">${yolcuVal.toFixed(1)}M</span></div></div>`);
    }

    init();
</script>
</body>
</html>
